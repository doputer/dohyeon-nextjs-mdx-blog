---
emoji: 'ğŸ“'
title: 'MDX ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆ ë¬¸ì œ í•´ê²°í•˜ê¸°'
description: 'ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¥¼ ë¶„ì„í•´ë´…ì‹œë‹¤'
tags:
  - image
  - size
  - blog
date: 2025-01-05
---

## ì´ë¯¸ì§€ Layout Shift

ì œ ë¸”ë¡œê·¸ì—ì„œëŠ” ê¸€ì˜ ì´í•´ë¥¼ ë•ê¸° ìœ„í•´ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ê³  ìˆëŠ”ë°ìš”. í˜ì´ì§€ ì§„ì… ì‹œ í˜¹ì€ ìƒˆë¡œê³ ì¹¨ ì‹œì— Layout Shiftê°€ ë°œìƒí•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤.

![](0.gif 'ì´ë¯¸ì§€ ì˜ì—­ì„ í™•ë³´ í•´ë†“ì§€ ëª»í•˜ëŠ” ëª¨ìŠµ')

ì´ë¯¸ì§€ë“¤ì„ `next/image`ì˜ Image íƒœê·¸ë¡œ ì²˜ë¦¬í•´ ë†“ì•˜ê¸° ë•Œë¬¸ì— ë Œë”ë§ ì‹œ ì´ë¯¸ì§€ í¬ê¸°ë§Œí¼ ì˜ì—­ì„ ì¡ì•„ë†”ì„œ ì´ëŸ° ë¬¸ì œê°€ ì—†ì„ ê±°ë¡œ ìƒê°í–ˆëŠ”ë° ì•„ë‹ˆì—ˆìŠµë‹ˆë‹¤.

```tsx img.tsx
const Img = (props: ImageProps) => {
  const caption = props?.title;
  const isUnoptimized = /.gif$/.test(props.src as string);

  return (
    <figure className="space-y-4">
      <Image
        {...props}
        // !mark(1:2)
        width={props.width || 0}
        height={props.height || 0}
        sizes="(max-width: 768px) 100vw, (max-width: 1200px) 80vw, 70vw"
        unoptimized={isUnoptimized}
      />
      {caption && <figcaption className="text-center text-sm text-mute">{caption}</figcaption>}
    </figure>
  );
};
```

ë‹¹ì—°íˆ ìˆì„ ê±°ë¼ ì˜ˆìƒí–ˆë˜ `props.width`ì™€ `props.height`ì˜ ê°’ì´ ì¡´ì¬í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

```json
{
  className: 'mx-auto rounded',
  src: '/images/~/0.png',
  alt: '',
  title: '',
}
```

Next.js ê³µì‹ ë¬¸ì„œì˜ [Image Optimization - Local images](https://nextjs.org/docs/app/getting-started/images#local-images)ë¥¼ ë³´ë©´ ì •ì ìœ¼ë¡œ import í•œ ì´ë¯¸ì§€ëŠ” Next.jsì—ì„œ ë³€í™˜í•´ì„œ `StaticImageData` ê°ì²´ë¡œ ë§Œë“ ë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆëŠ”ë°ìš”. ì´ ê²½ìš°ì—ëŠ” Next.jsê°€ ì•Œì•„ì„œ ì´ë¯¸ì§€ì˜ ì‚¬ì´ì¦ˆë¥¼ ì½ì–´ì„œ Layout Shift ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•Šê²Œ ë©ë‹ˆë‹¤.

í•˜ì§€ë§Œ ì œ ë¸”ë¡œê·¸ëŠ” MDXì—ì„œ ì‘ì„±í•œ ì´ë¯¸ì§€ë¥¼ ì§ì ‘ ê°€ì ¸ì˜¤ê¸° ë•Œë¬¸ì— Next.js ì´ë¯¸ì§€ ë³€í™˜ íŒŒì´í”„ë¼ì¸ì´ ë™ì‘í•˜ì§€ ì•Šê³ , ìœ„ì™€ ê°™ì€ ì •ë³´ë“¤ë§Œ ë‚¨ê²Œ ë©ë‹ˆë‹¤. ê·¸ë˜ì„œ í˜„ì¬ì™€ ê°™ì€ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ì„œ ì§ì ‘ ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆë¥¼ ë„£ì–´ì£¼ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.

## í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ í•´ê²°í•˜ê¸°

MDXëŠ” MDAST -> HAST ê³¼ì •ì„ ê±°ì³ì„œ JSXë¡œ ë³€í™˜ë˜ëŠ”ë°ìš”. HASTì— ìœ„ì™€ ê°™ì€ ê°ì²´ ì •ë³´ê°€ ë‚¨ì•„ìˆê³ , ì´ë•Œ íŠ¸ë¦¬ë¥¼ ìˆœíšŒí•˜ë©´ì„œ `src`ë¡œ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì™€ì„œ ì‚¬ì´ì¦ˆë¥¼ ê³„ì‚° í›„ ì¶”ê°€í•´ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ê³¼ì •ì— ì‰½ê²Œ ê°œì…í•˜ê¸° ìœ„í•´ `rehype` í”ŒëŸ¬ê·¸ì¸ì„ êµ¬í˜„í–ˆê³ , ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆ ê³„ì‚°ì„ ìœ„í•´ [image-size](https://github.com/image-size/image-size) ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì´ìš©í–ˆìŠµë‹ˆë‹¤.

```js rehype-image-size.mjs
const rehypeImageSize = () => {
  return async (tree) => {
    const promises = [];

    visit(tree, 'element', (node) => {
      if (node.tagName !== 'img') return;

      const { src, width, height } = node.properties;

      if (src && !(width && height)) {
        const filePath = path.join(dir, src);

        const promise = (async () => {
          const buffer = await readFile(filePath);

          // !mark
          const dimensions = sizeOf(buffer);

          if (dimensions.width && dimensions.height) {
            // !mark(1:2)
            node.properties.width = dimensions.width;
            node.properties.height = dimensions.height;
          }
        })();

        promises.push(promise);
      }
    });

    await Promise.all(promises);
  };
};
```

ì´ì œ ì´ í”ŒëŸ¬ê·¸ì¸ì„ ì ìš©í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ `props` ì´ë¯¸ì§€ì˜ `width`ì™€ `height`ê°€ ì¶”ê°€ëœ ê²Œ ë³´ì…ë‹ˆë‹¤.

```json
{
  className: 'mx-auto rounded',
  src: '/images/~/0.png',
  alt: '',
  title: '',
  // !mark(1:2)
  width: '634',
  height: '370'
}
```

ê·¸ë¦¬ê³  ë” ì´ìƒ ì´ë¯¸ì§€ë¡œ ì¸í•´ Layout Shiftê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ” ëª¨ìŠµë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](1.gif 'ë Œë”ë§ ì „ ì´ë¯¸ì§€ ì˜ì—­ì„ í™•ë³´í•´ ë†“ëŠ” ëª¨ìŠµ')

## image-size ë¼ì´ë¸ŒëŸ¬ë¦¬

ê·¸ëŸ°ë° ì†ì‰½ê²Œ ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆë¥¼ êµ¬í•´ì¤€ [image-size](https://github.com/image-size/image-size) ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ì–´ë–»ê²Œ ë™ì‘í•˜ëŠ” ê±¸ê¹Œìš”?

ê²°ë¡ ë¶€í„° ì´ì•¼ê¸°í•˜ìë©´ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ì´ë¯¸ì§€ íŒŒì¼ì„ ì½ê³ , íŒŒì¼ì˜ í—¤ë”ë¥¼ ë¶„ì„í•´ì„œ ì´ë¯¸ì§€ì˜ ì‚¬ì´ì¦ˆë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤. í—¤ë”ë¥¼ ë¶„ì„ ë°©ë²•ì€ íŒŒì¼ì˜ í¬ë§·ì— ë”°ë¼ ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

ì½”ë“œê°€ ì˜ ë¶„ë¦¬ë˜ì–´ ìˆì–´ì„œ ì½ëŠ” ë° ì–´ë ¤ì›€ì€ ì—†ìœ¼ì‹¤ í…ë°ìš”. `v2.0.2` ê¸°ì¤€ìœ¼ë¡œ `lib`ì˜ `fromFile -> lookup -> detector` ìˆœìœ¼ë¡œ íë¦„ì„ ë”°ë¼ê°€ ë´¤ìŠµë‹ˆë‹¤.

1. processQueue: íŒŒì¼ì„ ì½ê³ , ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¥¼ [Uint8Array](https://developer.mozilla.org/ko/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array)ì— ì €ì¥í•©ë‹ˆë‹¤.
2. detector: ë°”ì´ë„ˆë¦¬ ë°ì´í„°ì—ì„œ íŒŒì¼ì˜ í¬ë§·ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
3. calculate: í¬ë§·ì— ë§ì¶° í—¤ë”ë¥¼ ë¶„ì„í•´ì„œ ì´ë¯¸ì§€ì˜ ì‚¬ì´ì¦ˆë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.

ìƒê°ë³´ë‹¤ ê°„ë‹¨í•œ íë¦„ì¸ë°ìš”. íŒŒì¼ì˜ í¬ë§·ì„ ì¶”ì¶œí•˜ê³ , í—¤ë”ë¥¼ ë¶„ì„í•˜ëŠ” ê³¼ì •ì´ ì¬ë°ŒìŠµë‹ˆë‹¤.

## PNG ë‹¤ë¤„ë³´ê¸°

ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¸ê³ í•´ì„œ ì œ ë¸”ë¡œê·¸ì—ì„œ ê°€ì¥ ë§ì´ ì‚¬ìš©í•˜ëŠ” PNG í¬ë§·ì˜ ì‚¬ì´ì¦ˆë¥¼ ê³„ì‚°í•´ ë³´ê² ìŠµë‹ˆë‹¤.

ìš°ì„  ì•„ë¬´ PNG í¬ë§· ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ë‹¤ê°€ ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¥¼ ì°ì–´ë³´ë©´ ì•„ë˜ì²˜ëŸ¼ ë³´ì…ë‹ˆë‹¤.

![](2.png)

ì•„ë¬´ ì˜ë¯¸ ì—†ì–´ ë³´ì´ëŠ” ë°ì´í„° ê°™ì€ë°ìš”. PNGì˜ êµ¬ì¡°ë¥¼ ì•Œê³  ë‚˜ë©´ ì˜ë¯¸ ìˆëŠ” ë°ì´í„°ë¡œ ë³€í•©ë‹ˆë‹¤.

### PNG êµ¬ì¡°

[PNG SPEC v1.2](https://www.libpng.org/pub/png/spec/1.2/PNG-Contents.html) ë¬¸ì„œë¥¼ ë³´ë©´ PNG í¬ë§·ì˜ ìì„¸í•œ ìŠ¤íŒ©ì´ ì í˜€ìˆìŠµë‹ˆë‹¤.

**PNG file signature**

ì²˜ìŒ 8 byteì—ëŠ” í•­ìƒ ì•„ë˜ì™€ ê°™ì€ ê°’(10ì§„ìˆ˜)ì´ í¬í•¨ë©ë‹ˆë‹¤.

```txt
137 80 78 71 13 10 26 10
```

ìœ„ ê°’ì„ [TextDecoder](https://developer.mozilla.org/en-US/docs/Web/API/TextDecoder)ë¥¼ í†µí•´ UTF-8ìœ¼ë¡œ ë””ì½”ë“œí•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.

```
ï¿½PNG\r\n\x1A\n
```

ì´ íŒŒì¼ ì„œëª…ì„ í†µí•´ í•´ë‹¹ íŒŒì¼ì´ PNG í¬ë§·ì¸ì§€ ì•Œ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

**Chunk layout**

ì´ì–´ì„œ ì—¬ëŸ¬ ì¢…ë¥˜ì˜ `Chunk`ê°€ ë“±ì¥í•˜ëŠ”ë°ìš”. ì—­í• ë³„ë¡œ êµ¬ë¶„ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  `Chunk`ëŠ” ì•„ë˜ì™€ ê°™ì´ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

- Length(4 bytes): ë°ì´í„°ì˜ ê¸¸ì´
- Chunk Type(4 bytes): ì²­í¬ ì¢…ë¥˜(IHDR, IDAT, IEND, ...)
- Chunk Data(length bytes): ì‹¤ì œ ë°ì´í„°
- CRC(4 bytes): ì˜¤ë¥˜ ê²€ì‚¬

êµ¬ì¡°ë¥¼ ì‹œê°í™”í•´ ë³´ë©´ ì´í•´ê°€ ë” ì‰½ìŠµë‹ˆë‹¤.

```txt
[File Signature]
[Chunk #1]
  â”œâ”€ Length
  â”œâ”€ Chunk Type
  â”œâ”€ Chunk Data
  â””â”€ CRC
[Chunk #2]
  â”œâ”€ Length
  â”œâ”€ Chunk Type
  â”œâ”€ Chunk Data
  â””â”€ CRC
...
```

ì´ì œ `Chunk Type`ì„ ì‹ë³„í•˜ê³ , `Chunk Data`ì—ì„œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

ë„ˆë¹„ì™€ ë†’ì´ì— ëŒ€í•œ ì •ë³´ëŠ” `IHDR Chunk`ì˜ ë°ì´í„° ì•ˆì— ìˆìŠµë‹ˆë‹¤.

- Width(4 bytes)
- Height(4 bytes)
- Bit depth(1 byte)
- Color type(1 byte)
- Compression method(1 byte)
- Filter method(1 byte)
- Interlace method(1 byte)

> ì°¸ê³ ë¡œ `IHDR Chunk`ëŠ” `File signature` ë’¤ì— ê°€ì¥ ë¨¼ì € ë“±ì¥í•©ë‹ˆë‹¤.
>
> "The IHDR chunk must appear FIRST."
>
> [4.1.1. IHDR Image header](https://www.libpng.org/pub/png/spec/1.2/PNG-Chunks.html)

### PNG ì‚¬ì´ì¦ˆ ê³„ì‚°í•˜ê¸°

ì´ì œ ìœ„ êµ¬ì¡°ë¥¼ ì‹¤ì œ ì½”ë“œë¡œ ê²€ì¦í•´ ë³´ê² ìŠµë‹ˆë‹¤.

ì£¼ì–´ì§„ ì •ë³´ë¥¼ ì¢…í•©í•´ì„œ PNG ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆë¥¼ êµ¬í•˜ëŠ” ì—¬ì •ì„ ì •ë¦¬í•˜ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

1. File signatureê°€ PNGì¸ì§€ ê²€ì‚¬
2. Chunk Typeì´ IHDRì¸ì§€ ê²€ì‚¬
3. Width, Height ì¶”ì¶œ

ì´ ì—¬ì •ì„ ì•„ë˜ì™€ ê°™ì´ ì½”ë“œë¡œ í‘œí˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```ts
import * as fs from "node:fs";
import * as path from "node:path";

const process = async () => {
  const handle = await fs.promises.open(path.resolve("./image.png"), "r");
  const { size } = await handle.stat();
  const input = new Uint8Array(size);

  await handle.read(input, 0, size, 0);
  const imageSize = parser(input);
  await handle.close();

  return imageSize;
};

const pngSignature = "PNG\r\n\x1a\n";
const ihdrChunkType = "IHDR";

const parser = (input: Uint8Array) => {
  // File signatureê°€ PNGì¸ì§€ ê²€ì‚¬
  const signature = toUTF8String(input, 1, 8);
  if (signature !== pngSignature) return null;

  // Chunk Typeì´ IHDRì¸ì§€ ê²€ì‚¬
  const chunk = toUTF8String(input, 12, 16);
  if (chunk !== ihdrChunkType) return null;

  // Width, Height ì¶”ì¶œ
  const size = {
    width: readUInt32BE(input, 16),
    height: readUInt32BE(input, 20),
  };

  return size;
};

/* Utility */
const toUTF8String = (input: Uint8Array, start: number, end: number) => {
  const decoder = new TextDecoder();
  return decoder.decode(input.slice(start, end));
};
const readUInt32BE = (input: Uint8Array, offset = 0) => {
  const view = new DataView(input.buffer, input.byteOffset + offset);
  return view.getUint32(0, false);
};

await process();
```

## ëŠë‚€ì 

ë¸”ë¡œê·¸ì—ì„œ ë°œìƒí•œ Layout Shiftë¥¼ í•´ê²°í•˜ëŠ” ê³¼ì •ì—ì„œ ì´ë¯¸ì§€ í¬ë§·ì˜ êµ¬ì¡°ì™€ ë°”ì´ë„ˆë¦¬ ë°ì´í„° í•´ì„ê¹Œì§€ ê³µë¶€í•´ ë³¼ ìˆ˜ ìˆì–´ì„œ ì¦ê±°ì› ìŠµë‹ˆë‹¤.

ë˜ ì´ë¯¸ì§€ í¬ë§·ì˜ ëª…í™•í•œ SPECê³¼ ì´ë¥¼ ì§€ì¼œì˜¨ ì»¤ë®¤ë‹ˆí‹° ë•ë¶„ì— ì´ë¯¸ì§€ ë¶„ì„ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì•ˆì •ì ìœ¼ë¡œ ë™ì‘í•  ìˆ˜ ìˆì—ˆë‹¤ê³  ëŠê¼ˆìŠµë‹ˆë‹¤.

## ì°¸ê³  ìë£Œ

- [rehype-plugin Topics](https://github.com/topics/rehype-plugin)
- [PNG (Portable Network Graphics) Specification, Version 1.2](https://www.libpng.org/pub/png/spec/1.2/PNG-Contents.html)
